{% extends '@templates_path/base.html.twig' %}

 {% block title %}{{ title }}{% endblock %}

 {% block body %}
     {% include '@templates_path/header.html.twig' %}

{#     Chat template: https://mdbootstrap.com/docs/standard/extended/chat/#section-7#}

     <section>
         <div class="container py-5">

             <div class="row">
                 <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
                     <h5 class="font-weight-bold mb-3 text-center text-lg-start">My chats</h5>

                     <div class="card">
                         <div class="card-body">

                             <ul class="list-unstyled mb-0">
                                     {% for id, chat in chats %}
                                         <li class="p-2 border-bottom">
                                             <a href="#!"
                                                data-chat-id="{{ id }}"
                                                data-channel="{{ chat.ws_channel }}"
                                                class="d-flex justify-content-between"
                                                onclick="loadChat(this)">

                                                 <div class="d-flex flex-row">
                                                     <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/avatar-5.webp" alt="avatar"
                                                          class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">

                                                     <div class="pt-1">
                                                         <p class="fw-bold mb-0">{{ chat.partner_name }}</p>

                                                    {# TODO last chat message #}
{#                                                         <p class="small text-muted">Lorem ipsum dolor sit.</p>#}
                                                     </div>
                                                 </div>
                                                 {#  TODO last chat message datetime #}
{#                                                 <div class="pt-1">#}
{#                                                     <p class="small text-muted mb-1">Yesterday</p>#}
{#                                                 </div>#}
                                             </a>
                                         </li>

                                     {% endfor %}
                             </ul>

                         </div>
                     </div>

                 </div>

                 <div class="col-md-6 col-lg-7 col-xl-8">

                     <ul class="list-unstyled">
                         <li class="d-flex justify-content-between mb-4">
                             <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/avatar-6.webp" alt="avatar"
                                  class="rounded-circle d-flex align-self-start me-3 shadow-1-strong" width="60">
                             <div class="card">
                                 <div class="card-header d-flex justify-content-between p-3">
                                     <p class="fw-bold mb-0">Brad Pitt</p>
                                     <p class="text-muted small mb-0"><i class="far fa-clock"></i> 12 mins ago</p>
                                 </div>
                                 <div class="card-body">
                                     <p class="mb-0">
                                         Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut
                                         labore et dolore magna aliqua.
                                     </p>
                                 </div>
                             </div>
                         </li>
                         <li class="d-flex justify-content-between mb-4">
                             <div class="card w-100">
                                 <div class="card-header d-flex justify-content-between p-3">
                                     <p class="fw-bold mb-0">Lara Croft</p>
                                     <p class="text-muted small mb-0"><i class="far fa-clock"></i> 13 mins ago</p>
                                 </div>
                                 <div class="card-body">
                                     <p class="mb-0">
                                         Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque
                                         laudantium.
                                     </p>
                                 </div>
                             </div>
                             <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/avatar-5.webp" alt="avatar"
                                  class="rounded-circle d-flex align-self-start ms-3 shadow-1-strong" width="60">
                         </li>
                         <li class="d-flex justify-content-between mb-4">
                             <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/avatar-6.webp" alt="avatar"
                                  class="rounded-circle d-flex align-self-start me-3 shadow-1-strong" width="60">
                             <div class="card">
                                 <div class="card-header d-flex justify-content-between p-3">
                                     <p class="fw-bold mb-0">Brad Pitt</p>
                                     <p class="text-muted small mb-0"><i class="far fa-clock"></i> 10 mins ago</p>
                                 </div>
                                 <div class="card-body">
                                     <p class="mb-0">
                                         Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut
                                         labore et dolore magna aliqua.
                                     </p>
                                 </div>
                             </div>
                         </li>
                         <li class="bg-white mb-3">
                             <div data-mdb-input-init class="form-outline">
                                 <textarea class="form-control bg-body-tertiary" id="textAreaExample2" rows="4"></textarea>
                                 <label class="form-label" for="textAreaExample2">Message</label>
                             </div>
                         </li>
                         <button  type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-info btn-rounded float-end">Send</button>
                     </ul>

                 </div>

             </div>

         </div>
     </section>



{#     <div id="chat"></div>#}
{#     <input type="text" id="message" placeholder="Type a message...">#}
{#     <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>#}

     <script>
         const socket = new WebSocket('ws://localhost:8080');

         socket.onopen = function(e) {
             console.log("Connection established!");
             document.getElementById('sendBtn').disabled = false;
         };
         socket.onerror = function(e) {
             console.error("WebSocket error:", e);
         };
         socket.onclose = function(e) {
             console.warn("WebSocket closed:", e);
         };

         socket.onmessage = function(e) {
             const chat = document.getElementById('chat');
             const message = document.createElement('div');
             message.textContent = e.data;
             chat.appendChild(message);
         };

         function sendMessage() {
             const input = document.getElementById('message');
             sendToWsServer({
                 channel: 'personal_chat_1',
                 event: 'add_message',
                 userSender: 1,
                 userReceiver: 9,
                 message: input.value
             })
             input.value = '';
         }


         function sendToWsServer(wsObject) {
             if (socket.readyState === WebSocket.OPEN) {
                 socket.send(JSON.stringify(wsObject));
             } else {
                 console.warn("WebSocket is not open. Current state:", socket.readyState);
             }
         }

         function loadChat(chat) {
             console.log("loadChat");

             // const chatId = chat.dataset.chatId;
             // const channel = chat.dataset.channel;
             // const event = 'load_chat';
             //
             // console.log("Chat ID:", chatId);
             // console.log("Channel:", channel);
             // console.log("Event:", event);


             sendToWsServer({
                 channel: chat.dataset.channel,
                 event: 'load_chat',
                 chatId: chat.dataset.chatId,
             })

         }
     </script>


     {% include '@templates_path/footer.html.twig' %}
 {% endblock %}